INTSourceChangelist:2735870
Availability:Docs
Title: レベルストリーミングのユーザーガイド
Crumbs:
Description:レベルのリアルタイムな非同期ストリーミングを実現する方法

[REGION:todo]
	このページはアンリアル エンジン 3 のドキュメントから転載され現在見直しがされています。古い情報が含まれる場合もありますので予めご了承ください。
[/REGION]

[TOC(start:2)]



## 概要

このドキュメントの指示に従うことにより、アンリアル・エンジン 4ユーザーは、広大なシームレスワールドのイル―ジョンを実現するために、複数レベルのリアルタイムな同時ストリーミングを設定することができます。

ボリュームに基づいたレベルストリーミングに関する情報は、[Level Streaming Volumes] (Engine/LevelStreaming/StreamingVolumes)を参照してください。



## Persistent（パーシスタント）レベル

レベルをシームレスにブレンドする最初の手順として Persistent (持続可能な) レベルを作成します。このレベルは主にストリーム入出力を統括するマスターレベルとして捉えることができます。 

パーシスタントレベルの作成と、ストリーミングレベルをこのレベルへ追加する作業は、いくつかの簡単な手順で完了します： 

1. マップを新規に作成して、見えない領域にジオメトリの小さなキューブを追加します (エンジンはこのマップをレベルとして認識しますが、今後はこの手法は徐々に使用しなくなる予定です)。
1. プレイヤーのスタート位置を playerstart (プレイヤー開始地点) として配置します。パーシスタントレベルでは、この「playerstart」は空間に浮いている可能性が高いですが、一度レベルをストリーム入力すると、最初にストリーム入力したレベルではプレイヤーの開始点を好きな位置へ移動することができます。ゲームの開始時にパーシスタントレベル起動させますが、プレイヤーはパーシスタントレベルではなく、実際にストリーミングされたレベルの 1 つにあるジオメトリを移動します。  
1. パーシスタントレベルを表す名前を付けてマップを保存しておくと、管理しやすくなります。例えば、「Headquarters_P」などです。
1. 汎用ブラウザを開いて [Level] タブをクリックします。ストリーミング入力する全てのレベルをこのタブに記載しなくてはいけません。「Headquarters」が 3 つのマップから構成される場合、全てのマップをここに追加します。レベルのプルダウンメニューから [Level->New From File] を選択して追加します。ストリーミングレベルを追加する順序は重要ではありませんが、エディタおよびユーザーガイドの今後のバージョンではレベルが整理出来るように並び替え機能もサポートする予定です。最終的には以下に示す画像のような結果となります。 
1. _レベルをストリーミングする方法は、距離またはブループリントによるオプションが与えられます_:
    * 距離によるストリーミングは、レベルの原点からプレイヤーまでの距離に基づいてレベルをロードまたはアンロードします。 
    * ブループリントによるストリーミングは、ブループリントスクリプトを使用してデザイナーの思い通りのレベルをロードまたはアンロードすることができます。これは最も頻繁に使用される方法です。

![streamingImagenew1.jpg](streamingImagenew1.jpg)

**サンプル 1:ストリーミングされた 3 つのレベルを追加後のレベル ブラウザ**

CURRENT と表示されるレベルは、エディタ ウィンドウまたはブループリントで行われた変更に伴って修正されるレベルです。書き込み可能なマップである限り、複数のマップの作業を円滑に行うことができます。保存ボタンを押すと、CURRENT レベルが保存されます (もしくは [Save All Levels (すべてのレベルを保存)] ボタンをクリックして、パーシスタントレベルも含めて、ここに記載されているすべてのマップを保存することができます）。

[Visible] チェックボックスは、エディタでレベルの表示または非表示を切り替えますが、これは視覚上のみの問題で、ゲーム実行時にレベルがゲームへストリーム入力されるかどうかには関係しません。しかし、ここで見えないレベルは、レベルを再ビルドしても結果が反映されないため、複雑なレベルがある場合はレベルを不可視にしておくことで時間をかなり節約することができます。 

パーシスタントレベルからストリーム入力したレベルを永久に削除するために、ブラウザのレベルプルダウンからワールドを選択、その後 [Remove Level (レベルを削除)] を選択します。レベルのストリーミング方法を変更する場合、一度レベルを削除してから再度そのレベルを追加して、適用したいストリーミング方法を選択します。現時点で "Load" および "Unload" は機能していません。また、[Lock/Unlock] アイコンまたは Draw Bounding Box フラグも機能していません。 

![streamingImagenew2.jpg](streamingImagenew2.jpg)

**サンプル 2:右クリックから [Make Current (現在のレベル)] を選択して作業レベルを変更**


### パーシスタントレベルの作成方法（簡略版）


* Editor/UserGuide でマップを新規に作成します。
* キューブなどシンプルな BSP ジオメトリの一部を追加します。
* playerstart 地点を追加します。
* ストリーミングさせるレベルをレベルブラウザへ追加します。
* 名前を付けてマップを保存します。



## 距離に基づいたストリーミング

プレイヤーからの距離に基づいたストリーミング方法には追加の手順がいくつかあります。最初に、パーシスタントレベルが汎用ブラウザで選択されていることを確認してください。次に右側の [WorldSettings] カテゴリを展開します。[WorldSettings_#] を右クリックして、表示される [Edit Properties (環境設定を編集)] を選択します。 プロパティ ウィンドウで WorldSettings プロパティを開いて、次に StreamingLevels プロパティを開きます。ここに記載されるそれぞれのストリーミングレベルを確認してください。レベルがストリーミング入力するプレイヤーからの距離を [MaxDistance] フィールドに設定することができます。これはレベルのワールド空間にデフォルトで設定された (0、0、0) が中心となる球と考えてください。プレイヤーが球に入るとレベルのストリーミングが開始して、プレイヤーが球から離れるとレベルはアンロードされます。球の位置は変更可能です。レベル付近に近くとロードし、周辺エリアから離れるとアンロードするため、大抵のケースにおいてストリーミングしているレベルをこの球で完全に取り囲むことから、変更は必要となります。球の存在位置の可視化に対応する予定ですが、実際にはまだ実装されていません。 

この手法によるストリーミングは、レベルからプレイヤーまでの距離に基づいたレベルのロードおよびアンロードを何度も行う場合に便利です。レベルは表示/非表示ではなく、実際にストリーム入出力されているため、大きなマップの場合は遅延が顕著に表れることがあるかもしれません。 

![streamingImagenew4.jpg](streamingImagenew4.jpg)

**サンプル 4:距離に基づいたストリーミング**


### 距離に基づいたストリーミング (簡略版)


* 汎用ブラウザを開きます。
* [Level] タブをクリックします。
* 汎用ブラウザのファイル メニューから [Level] -> [New From File] を選択して、ストリーミング入力させるレベルをレベルブラウザへ追加します。
* [Distance (距離に基づいた)] ストリーミングを選択します。
* [Persistent Level] が選択されていることを確認してください。右側の [WorldSettings] プロパティを展開します。 [WorldSettings_#] を右クリックして、[Edit Properties] を選択します。
* 今開いているプロパティメニューから、[WorldSettings] プロパティを展開してた後に [StreamingLevels] を展開します。
* レベルをワールドへストリーミング入力したいプレイヤーからの距離を、ゲーム単位で入力します。原点は、ワールド空間で距離の計測を開始する位置へ変更します。 




## ストリーミングしたレベルの作業


### ロードとイベント

通常レベルのロード時に多くのイベントを展開させる Level Startup 操作の代わりに、新たなキズメット操作が追加されました。Level Loaded And Visible という機能です。基本的に Level Startup と同様の機能ですが、Change Level Visibility アクションと連動して作用するように設計されています。レベルがプレイヤーから見える状態になると、bMakeVisibleAfterLoad フラグをチェックしたまま CLV 操作またはレベルをストリーム入力することにより、常に Loaded And Visible アクションが発行されます。Remote Events と一緒に使うことにより、必要に応じてロードもしくはアンロードが行えて、ストリーム入力された別のレベルとイベントを与え合うことができる自己完結のエンティティとすることができます。例えば下の画像は、対象となるレベルが可視化されるとプレーヤが直ちにテレポートし、他のレベルからリモート イベントが発行されると何らかの生物のスポーンも行います。 

![streamingImagenew5.jpg](streamingImagenew5.jpg)

**サンプル 5:ストリーミング入力するレベルのスクリプトの例**


### レベル間のアクタの移動

2007 年 12 月 QA 承認ビルド以降は、あるレベルから単にアクタをコピーして、現レベルから別のレベルへ移動して貼り付ける (Ctrl+V) だけでアクタのレベル間移動が可能になりました。しかし、アクタ間の潜在的なリファレンスを解決するために_scratch_ワールドへシリアライズ (直列化)  なくてはいけないという点で、_MoveSelectedActorsToCurrentLevel_ と類似したパスウェイを使用します。この機能はチェンジリスト#203995 と #206418で導入されました。

2007 年 1 月 QA 承認ビルド以前は、一度にたくさんのアクタを移動させた時に _メモリ不足_ 問題を経験されたかもしれませんが、エディタ トランザクション バッファ (チェンジリスト#206829) のパフォーマンス (およびメモリ使用量) の改善時に修正されています。

さらに、2007  年1 月 QA ビルド承認ビルドでは、[レベル ブラウザ](Editor/Browsers/Levels) の [_New Level from Selected Actors_] ボタンを使用してアクタを新たなレベルへ移動させることができるようになりました (チェンジリスト #206324)。


### 最適化

ほとんどのデベロッパーは、パフォーマンスとワークフローの点から、ストリーミングレベルが多いほど良いと感じるはずです。これは現行システムの制限要素によって和らげられるべきです。つまり、あるレベルに配置されているアクタはキズメット内の別のレベルから直接参照することはできません。リモートイベントは、ストリーミングレベル全域でイベントをトリガーするために発行したり受け取ることができますが、この時点ではレベル全域でアクタを直接参照することはできません。上記の画像の Pathnode_0 と Pathnode_1 は、スクリプトと同レベル、この例では Headquarters_2 に位置していなければいけません。いずれかのノードが HQ_1 または 3 にある場合、これらの操作は機能しません。 

2007 年 12 月 QA 承認ビルド以降は、既存レベルを分割したストリーミングレベルへ簡単に分ける機能が追加されました。


* ワールドで複数のアクタを選択します。
* レベルブラウザの _Level_ から [_New Level from Selected Actors_] を選択します。
* 新たなストリーミングレベルがディスク上に作成されて、ワールドへ追加されます。その後選択したアクタは新規レベルへ移動されます。


より小さなストリーミングレベルセクションの作成が容易になりました！



##ストリーミング ボリューム

ボリュームに基づいたレベルストリーミング情報は、[Level Streaming Volumes](Engine/LevelStreaming/StreamingVolumes) を参照してください。



## まとめ

ゲームワールドへレベルを動的にストリーミング入出力させる方法の概観は以上です。この機能の多くは新機能で更新中の機能もあるため、新機能と簡素化が追加されるごとに本文を定期的に更新する予定です。 

 




