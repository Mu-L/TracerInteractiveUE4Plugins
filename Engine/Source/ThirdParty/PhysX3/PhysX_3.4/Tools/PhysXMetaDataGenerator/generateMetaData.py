from __future__ import print_function

import argparse
import os
import stat
import sys
import re
import platform
import shutil
from lib import utils
from lib import compare

# test mode: create copy of reference files
# update mode: try to open file in p4 if necessary
def setup_targetdir(metaDataDir, isTestMode):
	if isTestMode:
		targetDir = metaDataDir + "_test"
		if os.path.isdir(targetDir):
			print("deleting", targetDir)
			shutil.rmtree(targetDir)
		
		def ignore_non_autogen(dir, files):
			return filter(lambda f : not (os.path.isdir(os.path.join(dir, f)) 
											or re.search(r"AutoGenerated", f)), files)
		
		shutil.copytree(metaDataDir, targetDir, ignore=ignore_non_autogen)
		#set write to new files:
		for root, dirs, files in os.walk(targetDir):
			for file in files:
				os.chmod(os.path.join(root, file) , stat.S_IWRITE|stat.S_IREAD)
	else:
		targetDir = metaDataDir
		
		if not utils.check_files_writable(utils.list_autogen_files(targetDir)):
			utils.try_checkout_files(utils.list_autogen_files(targetDir))
		
		if not utils.check_files_writable(utils.list_autogen_files(targetDir)):
			print("auto generated meta data files not writable:", targetDir)
			print("aborting")
			sys.exit(1)
			
	utils.clear_files(utils.list_autogen_files(targetDir))
	return targetDir
		
# test mode: run perl script to compare reference and generated files
def test_targetdir(targetDir, metaDataDir, isTestMode):

	if isTestMode:
		print("compare generated meta data files with reference meta data files:")
		result = compare.compareMetaDataDirectories(targetDir, metaDataDir)
		if not result:
			print("failed!")
			sys.exit(1)
		else:
			print("passed.")

def get_osx_platform_path():
	cmd = "xcodebuild -showsdks"
	(stdout, stderr) = utils.run_cmd(cmd)
	if stderr != "":
		print(stderr)
		sys.exit(1)

	match = re.search(r"(-sdk macosx\d+.\d+)", stdout,  flags=re.MULTILINE)
	if not match:
		print("coundn't parse output of:\n", cmd, "\naborting!")
		sys.exit(1)

	sdkparam = match.group(0)
	cmd = "xcodebuild -version " + sdkparam + " Path"
	(sdkPath, stderr) = utils.run_cmd(cmd)
	if stderr != "":
		print(stderr)
		sys.exit(1)
	print("using sdk path:", sdkPath.rstrip())
	return sdkPath.rstrip()
	
def includeString(path):
	return ' -I"' + path + '"'

###########################################################################################################
# main
###########################################################################################################

parser = argparse.ArgumentParser(description='Generates meta data source files.')
parser.add_argument('-test',	help='enables testing mode, internal only', action='store_true')

args = parser.parse_args()

scriptDir = os.path.dirname(os.path.realpath(__file__))

try:
	os.makedirs("temp")
except:
	None

# find SDK_ROOT, EXTERNALS and PX_SHARED
sdkRoot = utils.find_root_path(scriptDir, "Source")

if os.path.isdir(os.path.join(sdkRoot, "../PhysX_3.4")):
	externalsRoot = os.path.join(sdkRoot, "../Externals")
	pxSharedRoot = os.path.join(sdkRoot, "../PxShared")
else:
	externalsRoot = os.path.join(utils.find_root_path(scriptDir, os.path.normpath("externals/clang")), "externals")
	pxSharedRoot = os.path.join(utils.find_root_path(scriptDir, "PxShared"), os.path.normpath("PxShared/1.0/trunk"))

print("testmode:", args.test)
print("root sdk:", sdkRoot)
print("root externals:", externalsRoot)
print("root shared:", pxSharedRoot)

boilerPlateFile = os.path.join(sdkRoot, os.path.normpath("Tools/PhysXMetaDataGenerator/PxBoilerPlate.h"))

includes = ''
includes += includeString(pxSharedRoot + '/include')
includes += includeString(pxSharedRoot + '/src/foundation/include')
includes += includeString(pxSharedRoot + '/src/pvd/include')
includes += includeString(pxSharedRoot + '/src/fastxml/include')
includes += includeString(sdkRoot + '/Include/common')
includes += includeString(sdkRoot + '/Include/geometry')
includes += includeString(sdkRoot + '/Include/pvd')
includes += includeString(sdkRoot + '/Include/particles')
includes += includeString(sdkRoot + '/Include/cloth')
includes += includeString(sdkRoot + '/Include/gpu')
includes += includeString(sdkRoot + '/Include')
includes += includeString(sdkRoot + '/Include/foundation')
includes += includeString(sdkRoot + '/Source/PhysXCommon/src')
includes += includeString(sdkRoot + '/Source/GeomUtils/headers')
includes += includeString(sdkRoot + '/Source/GeomUtils/src')
includes += includeString(sdkRoot + '/Source/GeomUtils/Opcode')
includes += includeString(sdkRoot + '/Source/PhysX/src')
includes += includeString(sdkRoot + '/Source/PhysX/src/buffering')
includes += includeString(sdkRoot + '/Source/PhysX/src/particles')
includes += includeString(sdkRoot + '/Source/PhysX/src/cloth')
includes += includeString(sdkRoot + '/Source/SimulationController/src')
includes += includeString(sdkRoot + '/Source/SimulationController/src/framework')
includes += includeString(sdkRoot + '/Source/SimulationController/include')
includes += includeString(sdkRoot + '/Source/PhysXCooking/include')
includes += includeString(sdkRoot + '/Source/SceneQuery')
includes += includeString(sdkRoot + '/Source/PhysXMetaData/core/include')
includes += includeString(sdkRoot + '/Source/PhysXGpu/include')
includes += includeString(sdkRoot + '/Tools/PhysXMetaDataGenerator')

print("platform:", platform.system())

commonFlags = '-DNDEBUG -DPX_GENERATE_META_DATA -x c++-header -std=c++0x -w -Wno-c++11-narrowing -fms-extensions '

if platform.system() == "Windows":
	# stddef.h doesn't compile with VS10 and -std=c++0x
	# for some reason -cc1 needs to go first in commonFlags
	commonFlags = '-cc1 ' + commonFlags
	platformFlags = '-DPX_VC=11 -D_WIN32 ' + ' -isystem"' + os.environ['VS110COMNTOOLS'] + '/../../VC/include"'
	clangExe = os.path.join(externalsRoot, os.path.normpath('clang/4.0.0/win32/bin/clang.exe'))
	debugFile = open("temp/clangCommandLine_windows.txt", "a")
	
elif platform.system() == "Linux":
	platformFlags = ''
	clangExe = os.path.join(externalsRoot, os.path.normpath('clang/4.0.0/linux32/bin/clang'))
	debugFile = open("temp/clangCommandLine_linux.txt", "a")
	
elif platform.system() == "Darwin":
	platformFlags = ' -isysroot' + get_osx_platform_path()
	clangExe = os.path.join(externalsRoot, os.path.normpath('clang/4.0.0/osx/bin/clang'))
	debugFile = open("temp/clangCommandLine_osx.txt", "a")
	
else:
	print("unsupported platform, aborting!")
	sys.exit(1)
	
commonFlags += ' -boilerplate-file ' + boilerPlateFile
	
#some checks
if not os.path.isfile(clangExe):
	print("didn't find,", clangExe, ", aborting!")
	sys.exit(1)

clangExe = '"' + clangExe + '"'
	
# required for execution of clang.exe
os.environ["PWD"] = os.path.join(sdkRoot, os.path.normpath("Tools/PhysXMetaDataGenerator"))

###############################
# PxPhysicsWithExtensions     #
###############################

print("PxPhysicsWithExtensions:")

srcPath = "PxPhysicsWithExtensionsAPI.h"
metaDataDir = os.path.join(sdkRoot, os.path.normpath("Source/PhysXMetaData"))

targetDir = setup_targetdir(metaDataDir, args.test)

cmd = " ".join(["", clangExe, commonFlags, "", platformFlags, includes, srcPath, "-o", '"'+targetDir+'"'])
print(cmd, file = debugFile)
(stdout, stderr) = utils.run_cmd(cmd)
if (stderr != "" or stdout != ""):
	print(stderr, "\n", stdout)
print("wrote meta data files in", targetDir)

test_targetdir(targetDir, metaDataDir, args.test)

###############################
# PxVehicleExtension          #
###############################

print("PxVehicleExtension:")

srcPath = "PxVehicleExtensionAPI.h"
metaDataDir = os.path.join(sdkRoot, os.path.normpath("Source/PhysXVehicle/src/PhysXMetaData"))

includes += includeString(sdkRoot + '/Include/vehicle')
includes += includeString(sdkRoot + '/Source/PhysXVehicle/src')
includes += includeString(pxSharedRoot + '/include/foundation')

targetDir = setup_targetdir(metaDataDir, args.test)

cmd = " ".join(["", clangExe, commonFlags, "", platformFlags, includes, srcPath, "-o", '"'+targetDir+'"'])
print(cmd, file = debugFile)
(stdout, stderr) = utils.run_cmd(cmd)
if (stderr != "" or stdout != ""):
	print(stderr, "\n", stdout)
print("wrote meta data files in", targetDir)

test_targetdir(targetDir, metaDataDir, args.test)

